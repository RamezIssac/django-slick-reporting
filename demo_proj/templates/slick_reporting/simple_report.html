{% extends 'slick_reporting/base.html' %}
{% load crispy_forms_tags i18n slick_reporting_tags static %}


{% block content %}


    <div class="col-12">

        {% if form %}


            <form id="reportForm" class="card">
                <div class="card-header">
                    <h3 class="card-title">Filters</h3>
                </div>
                <div class="card-body">


                    {% crispy form crispy_helper %}
                </div>
                <div class="card-footer text-end">
                    <input type="submit" value="Filter"
                           class="btn btn-primary  refreshReport">
                    <input type="button" value="Export Csv" class="btn btn-secondary exportCsvBtn">

                </div>
            </form>
        {% endif %}

        <div class="card" id="{{ report_data.report_slug }}">
            <div class="card-header">
                <h5 class="card-title">{% trans "Results" %}</h5>
            </div>
            <div class="card-body">

                <div data-report-widget
                     data-report-url="{{ request.path }}"
                     data-extra-params=""
                     data-form-selector="#reportForm"
                        {% if not auto_load %}
                     data-no-auto-load
                        {% endif %}


                     data-display-chart-selector="True"
                >
                    {#        {% block widget_content %}#}
                    {#            {% if display_chart %}#}
                    <div id="container" data-report-chart style="width:100%; height:400px;"></div>
                    {#                <canvas data-report-chart height="100"></canvas>#}
                    {#            {% endif %}#}
                    {#            {% if display_table %}#}
                    <div data-report-table>
                    </div>
                    {#            {% endif %}#}
                    {#        {% endblock %}#}

                </div>
            </div>
        </div>

    </div>

{% endblock %}
{% block _extrajs %}
    {{ block.super }}

    <script>
        $(document).ready(function () {


            let data = {{ report_data|jsonify }};

            let chartContainer = $('.reportChart')

            $('.exportCsvBtn').on('click', function (e) {
                e.preventDefault()
                let form = $('#reportForm');
                window.location = '?' + form.serialize() + '&_export=csv'
            });


            $('.chartContainer').on('click', '.nav-charts a', function (e) {
                e.preventDefault();
                let $this = $(this);
                let charts_engine = $this.attr('data-charts-engine');

                if (charts_engine === 'chartsjs') {
                    displayChartChartsJs($this)
                } else if (charts_engine === 'highcharts') {
                    displayCHartHighcharts($this);
                }

                let ul = $this.parents('ul');
                ul.find('li').removeClass('active'); //remove old active classes
                ul.find('li[data-chart-id=' + $this.attr("data-chart-id") + ']').addClass('active'); // set the new active class


            });

            function displayCHartHighcharts($this) {
                chartContainer.empty();
                chartContainer.append('<div id="highchartContainer" style="width:100%; height:400px;"></div>')

                let chart = chartContainer.find('#highchartContainer');
                let chartObject = $.slick_reporting.highcharts.createChartObject(data, $this.attr('data-chart-id'));
                chart.highcharts(chartObject)

            }

            function displayChartChartsJs($this) {
                chartContainer.empty();
                chartContainer.append('<canvas  width="400" height="100"></canvas>')
                var $chart = chartContainer.find('canvas');
                let chartObject = $.slick_reporting.chartsjs.createChartObject(data, $this.attr('data-chart-id'), {});
                myChart = new Chart($chart, chartObject);

            }

            $('table').DataTable();
            $('.nav-charts').find('a:first').trigger('click');
            {#setDatePicker();#}


        })
    </script>

{% endblock %}
